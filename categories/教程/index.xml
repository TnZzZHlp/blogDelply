<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>教程 on 明天吃什么？</title><link>https://tnzzz.top/categories/%E6%95%99%E7%A8%8B/</link><description>Recent content in 教程 on 明天吃什么？</description><generator>Hugo -- 0.147.8</generator><language>zh-cn</language><lastBuildDate>Tue, 20 May 2025 22:17:40 +0800</lastBuildDate><atom:link href="https://tnzzz.top/categories/%E6%95%99%E7%A8%8B/index.xml" rel="self" type="application/rss+xml"/><item><title>Debian 编译安装 unbound</title><link>https://tnzzz.top/posts/%E6%95%99%E7%A8%8B/debian%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85unbound/</link><pubDate>Tue, 20 May 2025 22:17:40 +0800</pubDate><guid>https://tnzzz.top/posts/%E6%95%99%E7%A8%8B/debian%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85unbound/</guid><description>&lt;h3 id="unbound-简介">unbound 简介&lt;/h3>
&lt;p>Unbound是一款验证型、递归式、带缓存的DNS解析器，旨在实现快速与轻量化，并融合了基于开放标准的现代特性。&lt;/p>
&lt;p>为增强在线隐私保护，Unbound支持DNS-over-TLS和DNS-over-HTTPS，使客户端能够加密通信。此外，它还支持多种现代标准，这些标准不仅减少了与权威服务器交换的数据量，提升了隐私性，还增强了DNS的健壮性。其中最为关键的技术包括查询名称最小化、积极利用DNSSEC验证缓存，以及对权威区域的支持，后者可用于加载根区域副本。&lt;/p>
&lt;p>Unbound兼容所有Linux和BSD发行版，以及macOS，大多数平台均有现成安装包。它已被纳入所有主要BSD操作系统的基础系统，以及大多数Linux发行版的标准软件库中，安装与配置简便易行，仅需几行配置即可为单机或网络设置解析器。&lt;/p>
&lt;p>作为遵循BSD许可证的自由开源软件，Unbound的产品开发路线图首要关注用户的安全与隐私。同时，所有功能均需依托成熟的开放标准。我们持续为所有用户优化Unbound的功能，这意味着我们不会为付费客户定制构建或提供专属功能。我们的优先级由用户反馈，特别是拥有支持合同的用户，以及更广泛的互联网社区所引导。在可能的情况下，赞助功能将获得更高优先级，并会逐案评估。
&lt;a href="https://www.nlnetlabs.nl/projects/unbound/about/">Source&lt;/a>&lt;/p>
&lt;h3 id="安装必要的依赖">安装必要的依赖&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>sudo apt update
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sudo apt install -y build-essential libssl-dev bison flex libhiredis-dev libevent-dev libsystemd-dev pkg-config make dns-root-data
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="下载并编译安装-unbound">下载并编译安装 unbound&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>git clone https://github.com/NLnetLabs/unbound
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>cd unbound
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>./configure --prefix&lt;span style="color:#f92672">=&lt;/span>/usr &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --sysconfdir&lt;span style="color:#f92672">=&lt;/span>/etc &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --localstatedir&lt;span style="color:#f92672">=&lt;/span>/var &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --runstatedir&lt;span style="color:#f92672">=&lt;/span>/run &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --with-username&lt;span style="color:#f92672">=&lt;/span>unbound &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --with-ssl &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --with-libevent &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --enable-systemd &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --enable-subnet &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --enable-tfo-client &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --enable-tfo-server &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --enable-cachedb &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --with-libhiredis &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --disable-rpath &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --with-pidfile&lt;span style="color:#f92672">=&lt;/span>/run/unbound/unbound.pid &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --with-rootkey-file&lt;span style="color:#f92672">=&lt;/span>/var/lib/unbound/root.key &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --with-libnghttp2 &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --with-libsodium &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --with-pthreads &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> --with-chroot-dir&lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>make &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> make install
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="说明">说明&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-plaintext" data-lang="plaintext">&lt;span style="display:flex;">&lt;span>`configure&amp;#39; 配置 unbound 1.23.1 以适应多种类型的系统。
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>用法: ./configure [选项]... [变量=值]...
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>要分配环境变量 (例如 CC, CFLAGS...), 请将它们指定为
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>变量=值。有关一些有用变量的描述，请参见下文。
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>选项的默认值在中括号内指定。
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>配置:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> -h, --help 显示此帮助信息并退出
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --help=short 显示此软件包特有的选项
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --help=recursive 显示所有包含的软件包的简短帮助信息
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> -V, --version 显示版本信息并退出
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> -q, --quiet, --silent 不打印 `checking ...&amp;#39; 消息
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --cache-file=FILE 将测试结果缓存在 FILE 中 [禁用]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> -C, --config-cache `--cache-file=config.cache&amp;#39; 的别名
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> -n, --no-create 不创建输出文件
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --srcdir=DIR 在 DIR 中查找源代码 [配置目录或 `..&amp;#39;]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>安装目录:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --prefix=PREFIX 将与体系结构无关的文件安装在 PREFIX 中
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [/usr/local]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --exec-prefix=EPREFIX 将与体系结构相关的文件安装在 EPREFIX 中
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [PREFIX]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>默认情况下, `make install&amp;#39; 会将所有文件安装在 `/usr/local/bin&amp;#39;, `/usr/local/lib&amp;#39; 等目录中。您可以使用 `--prefix` 指定一个不同于 `/usr/local&amp;#39; 的安装前缀, 例如 `--prefix=$HOME&amp;#39;。
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>为了更好地控制，请使用以下选项。
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>微调安装目录:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --bindir=DIR 用户可执行文件 [EPREFIX/bin]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --sbindir=DIR 系统管理员可执行文件 [EPREFIX/sbin]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --libexecdir=DIR 程序可执行文件 [EPREFIX/libexec]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --sysconfdir=DIR 只读的单机数据 [PREFIX/etc]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --sharedstatedir=DIR 可修改的与体系结构无关的数据 [PREFIX/com]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --localstatedir=DIR 可修改的单机数据 [PREFIX/var]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --runstatedir=DIR 可修改的每进程数据 [LOCALSTATEDIR/run]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --libdir=DIR 目标代码库 [EPREFIX/lib]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --includedir=DIR C 头文件 [PREFIX/include]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --oldincludedir=DIR 非 gcc 的 C 头文件 [/usr/include]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --datarootdir=DIR 只读的与体系结构无关的数据根目录 [PREFIX/share]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --datadir=DIR 只读的与体系结构无关的数据 [DATAROOTDIR]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --infodir=DIR info 文档 [DATAROOTDIR/info]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --localedir=DIR 区域设置相关的数据 [DATAROOTDIR/locale]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --mandir=DIR man 文档 [DATAROOTDIR/man]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --docdir=DIR 文档根目录 [DATAROOTDIR/doc/unbound]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --htmldir=DIR html 文档 [DOCDIR]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --dvidir=DIR dvi 文档 [DOCDIR]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --pdfdir=DIR pdf 文档 [DOCDIR]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --psdir=DIR ps 文档 [DOCDIR]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>系统类型:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --build=BUILD 为在 BUILD 上构建进行配置 [猜测值]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --host=HOST 交叉编译以构建在 HOST 上运行的程序 [BUILD]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>可选特性:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --disable-option-checking 忽略无法识别的 --enable/--with 选项
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --disable-FEATURE 不包含 FEATURE (等同于 --enable-FEATURE=no)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --enable-FEATURE[=ARG] 包含 FEATURE [ARG=yes]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --enable-checking 启用警告、断言、makefile 依赖关系
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --enable-debug 等同于 enable-checking
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --disable-flto 禁用链接时优化 (gcc 特定选项)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --enable-pie 启用位置无关可执行文件 (例如，为了充分
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 利用 ASLR，会有少量性能损失)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --enable-relro-now 在加载时启用完全重定位绑定 (RELRO
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> NOW, 以保护 GOT 和 .dtor 区域)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --enable-shared[=PKGS] 构建共享库 [默认=yes]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --enable-static[=PKGS] 构建静态库 [默认=yes]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --enable-fast-install[=PKGS]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 为快速安装进行优化 [默认=yes]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --disable-libtool-lock 避免锁定 (可能会破坏并行构建)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --disable-rpath 禁用硬编码的 rpath (默认=启用)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --disable-largefile 忽略对大文件的支持
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --enable-systemd 编译时支持 systemd (需要 libsystemd,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pkg-config)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --enable-alloc-checks 启用内存分配统计信息，用于调试
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --enable-alloc-lite 启用轻量级分配断言，用于调试
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --enable-alloc-nonregional 启用非区域分配，速度较慢但会将区域分配暴露给其他内存净化器，用于调试
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --disable-swig-version-check 禁用 swig 版本检查，以使用较旧的 swig 构建 python 模块即使这样做不可靠
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --disable-sha1 禁用 SHA1 RRSIG 支持，不会禁用 nsec3 支持
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --disable-sha2 禁用 SHA256 和 SHA512 RRSIG 支持
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --enable-subnet 启用客户端子网
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --disable-gost 禁用 GOST 支持
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --disable-ecdsa 禁用 ECDSA 支持
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --disable-dsa 禁用 DSA 支持
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --disable-ed25519 禁用 ED25519 支持
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --disable-ed448 禁用 ED448 支持
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --enable-event-api 启用 (实验性的) 可插拔事件基础
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> libunbound API，安装到 unbound-event.h
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --enable-tfo-client 为客户端模式启用 TCP Fast Open
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --enable-tfo-server 为服务器模式启用 TCP Fast Open
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --enable-static-exe 启用以针对未安装的 (事件) 库静态编译
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 可执行文件，用于调试
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --enable-fully-static 启用以完全静态编译
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --enable-lock-checks 启用以检查锁定和解锁调用，用于调试
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --enable-allsymbols 从 libunbound 导出所有符号并将二进制文件链接到它，安装尺寸更小但 libunbound 导出表会被内部符号污染
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --enable-dnstap 启用 dnstap 支持 (需要 protobuf-c)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --enable-dnscrypt 启用 dnscrypt 支持 (需要 libsodium)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --enable-cachedb 启用 cachedb 模块，可以使用外部缓存存储
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --enable-ipsecmod 启用 ipsecmod 模块，以促进机会性 IPsec
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --enable-ipset 启用 ipset 模块
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --disable-explicit-port-randomisation 禁用显式源端口随机化，并依赖 内核提供随机源端口
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --enable-linux-ip-local-port-range 定义此项以启用 /proc/sys/net/ipv4/ip_local_port_range 作为默认传出端口范围。这仅适用于 Linux 上的 libunbound 并且不影响 unbound 解析守护进程本身。这可能会严重限制可用的传出端口数量，从而降低随机性。仅当目标系统限制 (例如某些启用 SELinux 的发行版) 使用非临时端口时才定义此项。
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>可选软件包:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-PACKAGE[=ARG] 使用 PACKAGE [ARG=yes]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --without-PACKAGE 不使用 PACKAGE (等同于 --with-PACKAGE=no)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-conf-file=path Unbound 配置文件的路径名
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-run-dir=path 设置 chdir 到的默认目录 (默认为 cfg 文件所在的目录)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-chroot-dir=path 设置 chroot 到的默认目录 (默认为与 run-dir 相同)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-share-dir=path 设置共享数据的默认目录 (默认为 share/unbound)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-pidfile=filename 设置 unbound pid 文件的默认路径名 (默认 run-dir/unbound.pid)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-rootkey-file=filename 设置根密钥文件的默认路径名 (默认 run-dir/root.key)。此文件会被读取和写入。
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-rootcert-file=filename 设置根更新证书文件的默认路径名(默认 run-dir/icannbundle.pem)。如果您对内置证书满意，则此文件不必存在。
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-username=user 设置 unbound 更改到的默认用户 (默认用户是 unbound)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-pic[=PKGS] 尝试仅使用 PIC/非 PIC 对象 [默认=两者都使用]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-aix-soname=aix|svr4|both 在 AIX 上提供的共享库版本控制(又名 &amp;#34;SONAME&amp;#34;)变体, [默认=aix]。
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-gnu-ld 假设 C 编译器使用 GNU ld [默认=no]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-sysroot[=DIR] 在 DIR 中搜索依赖库 (如果未指定，则为编译器的 sysroot)。
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-pthreads 使用 pthreads 库，或使用 --without-pthreads禁用线程支持。
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-solaris-threads 使用 solaris 原生线程库。
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-syslog-facility=LOCAL0 - LOCAL7 设置 SYSLOG_FACILITY, 默认 DAEMON
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-dynlibmodule 构建动态库模块，或使用 --without-dynlibmodule 禁用它。(默认=no)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-pyunbound 构建 PyUnbound，或使用 --without-pyunbound 跳过它。 (默认=no)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-pythonmodule 构建 Python 模块，或使用 --without-pythonmodule 禁用脚本引擎。(默认=no)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-nss=path 使用 libnss 代替 openssl，安装在 path。
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-nettle=path 使用 libnettle 作为加密库，安装在 path。
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-ssl=pathname 启用 SSL (将检查 /usr/local/ssl /usr/lib/ssl /usr/ssl /usr/pkg /usr/local /opt/local /usr/sfw /usr 或指定类似 /usr/include/openssl11)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-libbsd 使用可移植的 libbsd 函数
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-deprecate-rsa-1024 弃用 RSA 1024 位长度，使其成为不受支持的密钥，用于 OpenSSL FIPS 拒绝 1024 位验证的情况
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-libevent=pathname 使用 libevent (将检查 /usr/local /opt/local /usr/lib /usr/pkg /usr/sfw /usr 或您可以指定一个显式路径)。速度较慢，但允许使用大的传出端口范围。
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-libexpat=path 为 libexpat 指定显式路径。
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-libhiredis=path 为 libhiredis 指定显式路径。
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-libnghttp2=path 为 libnghttp2 指定显式路径。
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-libngtcp2=path 为 libngtcp2 指定显式路径，用于 QUIC。
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-dnstap-socket-path=pathname 设置默认 dnstap 套接字路径
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-protobuf-c=path protobuf-c 的安装路径，用于 dnstap
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-libsodium=path libsodium 的安装路径，用于 dnscrypt
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-libmnl=path 为 libmnl 指定显式路径。
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> --with-libunbound-only 不构建守护进程和工具程序
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>一些有影响的环境变量:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CC C 编译器命令
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CFLAGS C 编译器标志
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> LDFLAGS 链接器标志, 例如 -L&amp;lt;lib dir&amp;gt; 如果您的库在非标准目录 &amp;lt;lib dir&amp;gt; 中
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> LIBS 传递给链接器的库, 例如 -l&amp;lt;library&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CPPFLAGS (Objective) C/C++ 预处理器标志, 例如 -I&amp;lt;include dir&amp;gt; 如果您的头文件在非标准目录 &amp;lt;include dir&amp;gt; 中
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> YACC 要使用的 `Yet Another Compiler Compiler&amp;#39; 实现。默认为找到的第一个程序: `bison -y&amp;#39;, `byacc&amp;#39;, `yacc&amp;#39;。
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> YFLAGS 默认传递给 $YACC 的参数列表。此脚本将 YFLAGS 默认为空字符串，以避免某些 make 应用程序给出的默认值 `-d&amp;#39;。
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> LT_SYS_LIBRARY_PATH 用户定义的运行时库搜索路径。
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> PKG_CONFIG pkg-config 工具的路径
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> PKG_CONFIG_PATH 添加到 pkg-config 搜索路径的目录
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> PKG_CONFIG_LIBDIR 覆盖 pkg-config 内置搜索路径的路径
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> CPP C 预处理器
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> SYSTEMD_CFLAGS SYSTEMD 的 C 编译器标志, 覆盖 pkg-config
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> SYSTEMD_LIBS SYSTEMD 的链接器标志, 覆盖 pkg-config
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> SYSTEMD_DAEMON_CFLAGS SYSTEMD_DAEMON 的 C 编译器标志, 覆盖 pkg-config
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> SYSTEMD_DAEMON_LIBS SYSTEMD_DAEMON 的链接器标志, 覆盖 pkg-config
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> PYTHON_VERSION 要使用的已安装 Python 版本，例如 &amp;#39;2.3&amp;#39;。此字符串将附加到 Python 解释器的规范名称。
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> SOURCE_DATE_EPOCH 如果设置了此变量，则使用该变量的值而不是当前时间作为构建时间戳。格式为 unix时间戳。这可以实现可重现的构建输出。
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> PROTOBUFC_CFLAGS PROTOBUFC 的 C 编译器标志, 覆盖 pkg-config
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> PROTOBUFC_LIBS PROTOBUFC 的链接器标志, 覆盖 pkg-config
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>使用这些变量来覆盖 `configure&amp;#39; 所做的选择，或帮助
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>它找到具有非标准名称/位置的库和程序。
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>将错误报告给 &amp;lt;unbound-bugs@nlnetlabs.nl 或 https://github.com/NLnetLabs/unbound/issues&amp;gt;。
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="创建-unbound-用户和组并配置">创建 unbound 用户和组并配置&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>groupadd --system unbound
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>useradd --no-create-home --system --shell /usr/sbin/nologin unbound
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>mkdir -p /var/lib/unbound
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>cp /usr/share/dns/root.key /var/lib/unbound/root.key
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>chown -R unbound:unbound /var/lib/unbound
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="创建-unbound-的-systemd-服务文件">创建 unbound 的 systemd 服务文件&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>cat &lt;span style="color:#e6db74">&amp;lt;&amp;lt;EOF &amp;gt; /etc/systemd/system/unbound.service
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">[Unit]
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">Description=Unbound DNS Resolver (Experimental Build)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">Documentation=man:unbound(8) man:unbound.conf(5) https://www.nlnetlabs.nl/projects/unbound/documentation.html
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">Wants=network-online.target
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">After=network-online.target
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># 如果您的 auto-trust-anchor-file 或 cachedb 路径位于 /var/lib/unbound，
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># 确保 /var 在此服务启动前已挂载。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">RequiresMountsFor=/var/lib/unbound /run
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">[Service]
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># === 基本配置 ===
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">Type=notify
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># Unbound 在 &amp;#39;--enable-systemd&amp;#39; 编译时支持 notify 类型，它会在服务完全准备好后通知 systemd。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># 指定运行 Unbound 的用户和组。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># 您在 ./configure 时使用了 --with-username=unbound。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># 您需要确保 &amp;#39;unbound&amp;#39; 用户和组在系统上存在。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># 例如:
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># sudo groupadd --system unbound
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># sudo useradd --system -g unbound -d /var/lib/unbound -s /bin/false -c &amp;#34;Unbound DNS Resolver&amp;#34; unbound
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">User=unbound
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">Group=unbound
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># 预启动检查配置文件
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">ExecStartPre=/usr/sbin/unbound-checkconf /etc/unbound/unbound.conf
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># 启动命令
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># -d: 不进行后台守护进程化 (systemd 处理)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># -p: 创建 PID 文件 (与 --with-pidfile 编译选项匹配)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># -c: 指定配置文件路径
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">ExecStart=/usr/sbin/unbound -d -p -c /etc/unbound/unbound.conf
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># 重载配置 (需要 unbound.conf 中启用 remote-control)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">ExecReload=/usr/sbin/unbound-control reload
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># 重启策略
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">Restart=on-failure
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">RestartSec=5s
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># PID 文件路径 (与 --with-pidfile 编译选项匹配)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># RuntimeDirectory 会自动创建 /run/unbound 并设置权限给指定用户
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">PIDFile=/run/unbound/unbound.pid
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># === 资源和权限管理 ===
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># 运行时目录，systemd 会创建 /run/unbound 并设置所有权为 User 和 Group 指定的用户/组
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">RuntimeDirectory=unbound
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">RuntimeDirectoryMode=0750
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># 能力绑定
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># CAP_NET_BIND_SERVICE 允许 &amp;#39;unbound&amp;#39; 用户绑定到特权端口 (如53)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">AmbientCapabilities=CAP_NET_BIND_SERVICE
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">CapabilityBoundingSet=CAP_NET_BIND_SERVICE CAP_SETGID CAP_SETUID
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># 如果在 unbound.conf 中启用了 chroot，并且 Unbound 在降权为 &amp;#39;unbound&amp;#39; 用户后才执行 chroot,
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># 则可能还需要 CAP_SYS_CHROOT。但通常 chroot 在降权前由root完成，或者Unbound启动时即为&amp;#39;unbound&amp;#39;用户，则无法chroot到任意目录。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># 您的 --with-username=unbound 意味着Unbound会自行处理权限。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># --- 安全强化选项 ---
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">#NoNewPrivileges=yes
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">#ProtectSystem=no
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># 如果 ProtectSystem=strict 导致 Unbound 无法写入其管理的 root.key 或 cachedb (通常在 /var/lib/unbound/)：
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># 您需要添加 ReadWritePaths 指令。例如：
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># ReadWritePaths=/var/lib/unbound
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># 如果您在 unbound.conf 中使用了 chroot: &amp;#34;/etc/unbound&amp;#34; 并且需要在其中写入 (如 root.key):
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># ReadWritePaths=/etc/unbound
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">#ProtectHome=no
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">#PrivateTmp=no
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">#PrivateDevices=yes
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># MemoryDenyWriteExecute=yes # 如果系统和Unbound版本支持，可增强安全性
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">[Install]
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">WantedBy=multi-user.target
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="创建-unbound-的配置文件">创建 unbound 的配置文件&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>cat &lt;span style="color:#e6db74">&amp;lt;&amp;lt;EOF &amp;gt; /etc/unbound/unbound.conf
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># Unbound configuration file
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">#
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># See unbound.conf(5) man page for more information.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">#
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># 注意: 路径 (例如 logfile, root-hints, auto-trust-anchor-file)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># 可能需要根据您的操作系统和Unbound安装方式进行调整。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># 确保Unbound进程对指定的日志文件和自动信任锚点文件具有写入权限（或对其目录）。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">server:
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # --- 基本服务器设置 ---
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> verbosity: 0 # 日志详细级别 (0=仅错误, 1=操作信息, 2=详细操作, ... 5=非常详细)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> #logfile: &amp;#34;/var/log/unbound/unbound.log&amp;#34; # 日志文件路径。如果注释掉或为空，则可能记录到syslog。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # 例如: FreeBSD: /var/unbound/unbound.log, OpenBSD: Unbound chroots and logs via syslog
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # Linux (from package): often /var/log/unbound.log or uses systemd journal
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> use-syslog: no # 如果指定了 logfile，设为 no 则仅记录到文件。设为 yes 则也发送到 syslog。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> module-config: &amp;#34;validator cachedb iterator&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> interface: 0.0.0.0 # 监听所有 IPv4 地址
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> interface: ::0 # 监听所有 IPv6 地址 (如果您的系统支持IPv6)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> port: 54 # 监听的端口 (DNS标准端口)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> do-ip4: yes # 允许 IPv4
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> do-ip6: yes # 允许 IPv6 (如果网络支持)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> do-udp: yes # 允许 UDP
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> do-tcp: yes # 允许 TCP
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # --- 访问控制 ---
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # 定义哪些客户端IP地址或子网可以查询此服务器。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # 强烈建议配置此项以防止滥用。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> access-control: 127.0.0.0/8 allow # 允许本地回环地址 (IPv4)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> access-control: ::1/128 allow # 允许本地回环地址 (IPv6)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # 示例：允许常见的私有网络范围。根据您的网络调整或添加。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> access-control: 192.168.0.0/16 allow
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> access-control: 10.0.0.0/8 allow
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> access-control: 172.16.0.0/12 allow
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # access-control: ::ffff:127.0.0.1/128 allow # IPv4-mapped IPv6 localhost
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # --- 性能和缓存设置 ---
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> msg-cache-size: 10m # DNS消息缓存大小 (查询和应答)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> rrset-cache-size: 20m # RRset缓存大小 (DNS资源记录)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # 缓存相关的 slab 数量，通常可以设为接近 num-threads 的值或者2的幂次方。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> msg-cache-slabs: 4
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> rrset-cache-slabs: 4
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> num-threads: 2 # 创建的线程数。理想情况下，设置为CPU核心数。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # 对于较小的部署，1或2通常足够。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # 增加传出查询可用的端口范围，有助于防止某些类型的攻击。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> outgoing-range: 1024
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # 每个线程可以并发处理的查询数上限。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> num-queries-per-thread: 2048
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # --- 过期缓存与预取功能 (Requested &amp;#34;过期缓存功能&amp;#34;) ---
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> prefetch: yes # 在缓存条目过期前主动获取更新，保持常用条目新鲜。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> prefetch-key: yes # 在验证DS记录时，提前获取DNSKEY记录，加速后续DNSSEC验证。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> serve-expired: yes # 在尝试获取新记录的同时，从缓存中提供已过期的记录。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # 这可以提高当上游权威服务器缓慢或无响应时的可用性。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> serve-expired-ttl: 3600 # (1小时) 提供已过期记录时，该记录的TTL值。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> serve-expired-reply-ttl: 30 # (30秒) 当提供过期数据时，客户端应该缓存这条过期数据的TTL。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> serve-expired-client-timeout: 1000 # (1秒) 在提供过期数据之前，等待新答案的最长时间（毫秒）。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # --- 安全设置 ---
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> harden-glue: yes # 强化对胶水记录的验证。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> harden-dnssec-stripped: yes # 防止DNSSEC剥离攻击。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> harden-algo-downgrade: yes # 防止算法降级攻击。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> use-caps-for-id: yes # 在查询ID中使用随机大小写混合（0x20技巧）来增加欺骗难度。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> edns-buffer-size: 1232 # EDNS0 UDP包的建议大小，以减少IP分片。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> hide-identity: yes # 拒绝回应 id.server 和 hostname.bind 的查询。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> hide-version: yes # 拒绝回应 version.server 和 version.bind 的查询。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # 定义私有地址范围，Unbound会从DNS响应中剥离这些地址，以防止DNS重绑定攻击。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> private-address: 10.0.0.0/8
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> private-address: 172.16.0.0/12
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> private-address: 192.168.0.0/16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> private-address: 169.254.0.0/16
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> private-address: fd00::/8
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> private-address: fe80::/10
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # private-domain: &amp;#34;example.com&amp;#34; # 如果您有不想被外部解析的内部域名，可以在这里声明。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # 不查询回环地址上的公共域名，防止潜在的循环或安全问题。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> do-not-query-localhost: yes
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # --- DNSSEC 验证 ---
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # 自动管理和更新根信任锚点。Unbound需要对该文件的目录有写权限，或者您可以手动管理此文件。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # 路径可能为: /var/lib/unbound/root.key (Debian/Ubuntu), /usr/local/etc/unbound/root.key (FreeBSD ports),
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # /etc/unbound/root.key (generic from source), /opt/homebrew/etc/unbound/root.key (macOS Homebrew)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> auto-trust-anchor-file: &amp;#34;/var/lib/unbound/root.key&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> val-log-level: 1 # DNSSEC验证失败时的日志级别 (1=基本信息, 2=详细信息)。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # --- 根提示文件 (Root Hints) ---
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # 如果Unbound作为递归解析器直接从根服务器开始解析 (而不是转发模式)，则需要此文件。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # 确保此文件存在并且保持最新。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # 路径可能为: /usr/share/dns/root.hints (common on Linux), /etc/unbound/root.hints,
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # /usr/local/etc/unbound/root.hints
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> root-hints: &amp;#34;/usr/share/dns/root.hints&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # --- 转发模式 (可选) ---
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # 如果您希望Unbound将所有查询转发到其他上游DNS服务器，而不是自己从根进行递归解析，
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # 请取消注释并配置以下部分。如果启用了转发，则上面的 root-hints 通常不再需要。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # forward-zone:
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # name: &amp;#34;.&amp;#34; # 转发所有查询
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # # 常用的公共DNS服务器示例:
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # forward-addr: 8.8.8.8@53 # Google
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # forward-addr: 8.8.4.4@53 # Google
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # forward-addr: 1.1.1.1@53 # Cloudflare
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # forward-addr: 1.0.0.1@53 # Cloudflare
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # # 如果您的上游服务器支持DNS-over-TLS (DoT):
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # # forward-tls-upstream: yes
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # # forward-addr: 1.1.1.1@853#cloudflare-dns.com # DoT示例，主机名用于证书验证
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># --- 远程控制 (可选) ---
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># 允许使用 unbound-control 工具管理Unbound服务。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># 如果启用，请确保使用 unbound-control-setup 生成密钥和证书文件。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># remote-control:
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># control-enable: yes
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># control-interface: 127.0.0.1 # 监听远程控制连接的IP地址
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># control-port: 8953 # 监听远程控制连接的端口
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># # 以下文件路径也需要根据您的安装进行调整
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># server-key-file: &amp;#34;/etc/unbound/unbound_server.key&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># server-cert-file: &amp;#34;/etc/unbound/unbound_server.pem&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># control-key-file: &amp;#34;/etc/unbound/unbound_control.key&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># control-cert-file: &amp;#34;/etc/unbound/unbound_control.pem&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"># cachedb:
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # backend: &amp;#34;redis&amp;#34; # 指定后端为 redis (这通常也适用于Valkey)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # --- Redis/Valkey 服务器连接参数 ---
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # redis-server-host: 192.168.2.11
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # redis-server-port: 6379
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> #redis-server-path: &amp;#34;/run/valkey/valkey-server.sock&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # redis-server-password: &amp;#34;your_valkey_password&amp;#34; # 如果Valkey设置了密码
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # redis-database: 0 # 可选，Valkey/Redis数据库编号 (默认为0)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # --- 可选的 Redis/Valkey 相关超时设置 (如果后端驱动支持) ---
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # redis-timeout: 100 # 连接和操作超时 (毫秒)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # --- 缓存数据密钥前缀 (可选) ---
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # redis-key-prefix: &amp;#34;unbound_cache:&amp;#34; # 避免与其他应用在同一Valkey实例中的键冲突
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # --- 其他 cachedb 通用设置 (可能适用) ---
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> # cachedb-no-store: no # 是否存储否定缓存条目 (默认为no，即存储)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="启动-unbound-服务">启动 unbound 服务&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>sudo systemctl daemon-reload
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sudo systemctl enable unbound
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sudo systemctl start unbound
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="检查-unbound-服务状态">检查 unbound 服务状态&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-shell" data-lang="shell">&lt;span style="display:flex;">&lt;span>sudo systemctl status unbound
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>ffmpeg 将视频转码至 h265 编码</title><link>https://tnzzz.top/posts/%E6%95%99%E7%A8%8B/ffmpeg-%E5%B0%86%E8%A7%86%E9%A2%91%E8%BD%AC%E7%A0%81%E8%87%B3-h265-%E7%BC%96%E7%A0%81/</link><pubDate>Tue, 20 May 2025 22:17:40 +0800</pubDate><guid>https://tnzzz.top/posts/%E6%95%99%E7%A8%8B/ffmpeg-%E5%B0%86%E8%A7%86%E9%A2%91%E8%BD%AC%E7%A0%81%E8%87%B3-h265-%E7%BC%96%E7%A0%81/</guid><description>&lt;h3 id="ffmpeg-简介">ffmpeg 简介&lt;/h3>
&lt;p>FFmpeg是一个开源的音视频处理工具，支持录制、转换数字音频、视频，并能将其转化为流。它包含了一个完整的解决方案，能够处理几乎所有的音视频格式。&lt;/p>
&lt;p>FFmpeg的核心是libavcodec库，它提供了多种音视频编解码器，支持从简单的音频转码到复杂的视频处理任务。FFmpeg还提供了丰富的命令行工具，用户可以通过命令行轻松实现音视频的转换、剪辑、合并等操作。&lt;/p>
&lt;p>FFmpeg的跨平台特性使其能够在Linux、Windows和macOS等多种操作系统上运行。它的强大功能和灵活性使其成为音视频处理领域的事实标准。&lt;/p>
&lt;p>&lt;a href="https://ffmpeg.org/">Source&lt;/a>&lt;/p>
&lt;h3 id="必要条件">必要条件&lt;/h3>
&lt;ul>
&lt;li>安装FFmpeg：确保你的系统上已经安装了FFmpeg。&lt;/li>
&lt;/ul>
&lt;h3 id="转码命令">转码命令&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># Intel QuickSync (hevc_qsv)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 参数:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># -global_quality: 1–51（类似 CRF，数值越大质量越低，文件越小，默认23）&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># -preset: ultrafast | fast | medium | slow | slower | veryslow（速度↑/压缩率↓，默认medium）&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ffmpeg -y -i input.mp4 &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -c:v hevc_qsv -global_quality &lt;span style="color:#ae81ff">23&lt;/span> -preset medium &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -c:a copy -c:s copy &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> output_h265_intel.mp4
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># AMD AMF (hevc_amf)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 参数:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># -qp: 0–51（质量参数，数值越大压缩越强，默认23）&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># -quality: speed | balanced | quality（speed=最快最低质；balanced=中；quality=最高质，默认balanced）&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ffmpeg -y -i input.mp4 &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -c:v hevc_amf -rc cqp -qp &lt;span style="color:#ae81ff">23&lt;/span> -quality balanced &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -c:a copy -c:s copy &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> output_h265_amd.mp4
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># NVIDIA NVENC (hevc_nvenc)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 参数:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># -cq: 0–51（质量参数，数值越大质量越低，文件越小，默认23）&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># -preset: ultrafast | fast | medium | slow | slower | veryslow（同x265预设，默认medium）&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ffmpeg -y -i input.mp4 &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -c:v hevc_nvenc -cq &lt;span style="color:#ae81ff">23&lt;/span> -preset medium &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -c:a copy -c:s copy &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> output_h265_nvidia.mp4
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-bash" data-lang="bash">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 软件 x265 (libx265)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># 参数:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># -crf: 0–51（数值越大压缩越强，默认23）&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># -preset: ultrafast | fast | medium | slow | slower | veryslow（速度↑/压缩率↓，默认medium）&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ffmpeg -y -i input.mp4 &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -c:v libx265 -crf &lt;span style="color:#ae81ff">23&lt;/span> -preset medium &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> -c:a copy -c:s copy &lt;span style="color:#ae81ff">\
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#ae81ff">&lt;/span> output_h265_x265.mp4
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="python-脚本">Python 脚本&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#!/usr/bin/env python3&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"># -*- coding: utf-8 -*-&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">&amp;#34;&amp;#34;&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">将视频文件转码为H.265编码。
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">用法: python convert_to_h265.py &amp;lt;视频文件路径&amp;gt; [--intel] [--amd] [--nvidia]
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">使用 --intel 参数启用 Intel QuickSync 硬件加速
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">使用 --amd 参数启用 AMD AMF 硬件加速
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">使用 --nvidia 参数启用 NVIDIA NVENC 硬件加速
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">&amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">import&lt;/span> argparse
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">import&lt;/span> os
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">import&lt;/span> subprocess
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">import&lt;/span> sys
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">def&lt;/span> &lt;span style="color:#a6e22e">convert_to_h265&lt;/span>(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> input_file,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> use_intel&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">False&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> use_amd&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">False&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> use_nvidia&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">False&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> crf&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">23&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> preset&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;medium&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> bitrate&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">None&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;&amp;#34;&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> 使用ffmpeg将视频转码为H.265格式
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> 参数:
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> input_file: 输入视频文件路径
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> use_intel: 是否使用Intel QuickSync硬件加速
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> use_amd: 是否使用AMD AMF硬件加速
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> use_nvidia: 是否使用NVIDIA NVENC硬件加速
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#e6db74"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 检查文件是否存在&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#f92672">not&lt;/span> os&lt;span style="color:#f92672">.&lt;/span>path&lt;span style="color:#f92672">.&lt;/span>isfile(input_file):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print(&lt;span style="color:#e6db74">f&lt;/span>&lt;span style="color:#e6db74">&amp;#34;错误: 文件不存在 - &lt;/span>&lt;span style="color:#e6db74">{&lt;/span>input_file&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">False&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 构建输出文件路径&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> file_dir &lt;span style="color:#f92672">=&lt;/span> os&lt;span style="color:#f92672">.&lt;/span>path&lt;span style="color:#f92672">.&lt;/span>dirname(input_file)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> file_name, file_ext &lt;span style="color:#f92672">=&lt;/span> os&lt;span style="color:#f92672">.&lt;/span>path&lt;span style="color:#f92672">.&lt;/span>splitext(os&lt;span style="color:#f92672">.&lt;/span>path&lt;span style="color:#f92672">.&lt;/span>basename(input_file))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> output_file &lt;span style="color:#f92672">=&lt;/span> os&lt;span style="color:#f92672">.&lt;/span>path&lt;span style="color:#f92672">.&lt;/span>join(file_dir, &lt;span style="color:#e6db74">f&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#e6db74">{&lt;/span>file_name&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">_h265&lt;/span>&lt;span style="color:#e6db74">{&lt;/span>file_ext&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 将 Windows 路径反斜杠改为正斜杠，避免 \0 被误识别&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> input_file &lt;span style="color:#f92672">=&lt;/span> input_file&lt;span style="color:#f92672">.&lt;/span>replace(&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#ae81ff">\\&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;/&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> output_file &lt;span style="color:#f92672">=&lt;/span> output_file&lt;span style="color:#f92672">.&lt;/span>replace(&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#ae81ff">\\&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>, &lt;span style="color:#e6db74">&amp;#34;/&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 构建 ffmpeg 命令&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ffmpeg_cmd &lt;span style="color:#f92672">=&lt;/span> [
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;ffmpeg&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;-y&amp;#34;&lt;/span>, &lt;span style="color:#75715e"># 如果目标已存在则强制覆盖&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;-i&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> input_file,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 硬件／软件编码选择&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> use_intel:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ffmpeg_cmd&lt;span style="color:#f92672">.&lt;/span>extend(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;-c:v&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;hevc_qsv&amp;#34;&lt;/span>, &lt;span style="color:#75715e"># Intel QuickSync HEVC/H.265编码器&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;-global_quality&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> str(crf), &lt;span style="color:#75715e"># QSV 对应的质量参数&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;-preset&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> preset,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">elif&lt;/span> use_amd:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 将 --preset 映射到 AMF 的 quality 参数&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> amf_quality &lt;span style="color:#f92672">=&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;ultrafast&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;speed&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;fast&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;speed&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;medium&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;balanced&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;slow&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;quality&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;slower&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;quality&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;veryslow&amp;#34;&lt;/span>: &lt;span style="color:#e6db74">&amp;#34;quality&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }&lt;span style="color:#f92672">.&lt;/span>get(preset, &lt;span style="color:#e6db74">&amp;#34;balanced&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ffmpeg_cmd&lt;span style="color:#f92672">.&lt;/span>extend(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;-c:v&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;hevc_amf&amp;#34;&lt;/span>, &lt;span style="color:#75715e"># AMD HEVC/H.265编码器&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;-rc&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;cqp&amp;#34;&lt;/span>, &lt;span style="color:#75715e"># AMF 使用 CQP 模式&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;-qp&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> str(crf), &lt;span style="color:#75715e"># AMF 的质量参数&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;-quality&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> amf_quality, &lt;span style="color:#75715e"># AMF 支持的 quality 选项&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">elif&lt;/span> use_nvidia:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ffmpeg_cmd&lt;span style="color:#f92672">.&lt;/span>extend(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;-c:v&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;hevc_nvenc&amp;#34;&lt;/span>, &lt;span style="color:#75715e"># NVIDIA NVENC H.265编码器&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;-cq&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> str(crf), &lt;span style="color:#75715e"># NVENC 的质量参数&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;-preset&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> preset,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 软件 x265 编码&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ffmpeg_cmd&lt;span style="color:#f92672">.&lt;/span>extend(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;-c:v&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;libx265&amp;#34;&lt;/span>, &lt;span style="color:#75715e"># 软件x265编码器&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;-crf&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> str(crf),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;-preset&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> preset,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 如果指定了固定码率，则覆盖质量参数&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> bitrate:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ffmpeg_cmd&lt;span style="color:#f92672">.&lt;/span>extend([&lt;span style="color:#e6db74">&amp;#34;-b:v&amp;#34;&lt;/span>, bitrate])
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 添加通用的编码参数&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ffmpeg_cmd&lt;span style="color:#f92672">.&lt;/span>extend(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;-c:a&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;copy&amp;#34;&lt;/span>, &lt;span style="color:#75715e"># 复制音频流&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;-c:s&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;copy&amp;#34;&lt;/span>, &lt;span style="color:#75715e"># 复制字幕流 (如果有)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> output_file,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print(&lt;span style="color:#e6db74">f&lt;/span>&lt;span style="color:#e6db74">&amp;#34;正在转码: &lt;/span>&lt;span style="color:#e6db74">{&lt;/span>input_file&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print(&lt;span style="color:#e6db74">f&lt;/span>&lt;span style="color:#e6db74">&amp;#34;输出文件: &lt;/span>&lt;span style="color:#e6db74">{&lt;/span>output_file&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print(&lt;span style="color:#e6db74">&amp;#34;转码中，请稍候...&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">try&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 执行ffmpeg命令&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> process &lt;span style="color:#f92672">=&lt;/span> subprocess&lt;span style="color:#f92672">.&lt;/span>Popen(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ffmpeg_cmd,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> stdout&lt;span style="color:#f92672">=&lt;/span>subprocess&lt;span style="color:#f92672">.&lt;/span>PIPE,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> stderr&lt;span style="color:#f92672">=&lt;/span>subprocess&lt;span style="color:#f92672">.&lt;/span>STDOUT,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> universal_newlines&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#66d9ef">True&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 安全地处理并显示进度信息&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> process&lt;span style="color:#f92672">.&lt;/span>stdout: &lt;span style="color:#75715e"># 确保stdout不是None&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> line &lt;span style="color:#f92672">in&lt;/span> process&lt;span style="color:#f92672">.&lt;/span>stdout:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 仅显示包含关键字的行以减少输出量&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> &lt;span style="color:#e6db74">&amp;#34;frame=&amp;#34;&lt;/span> &lt;span style="color:#f92672">in&lt;/span> line &lt;span style="color:#f92672">or&lt;/span> &lt;span style="color:#e6db74">&amp;#34;speed=&amp;#34;&lt;/span> &lt;span style="color:#f92672">in&lt;/span> line &lt;span style="color:#f92672">or&lt;/span> &lt;span style="color:#e6db74">&amp;#34;error&amp;#34;&lt;/span> &lt;span style="color:#f92672">in&lt;/span> line&lt;span style="color:#f92672">.&lt;/span>lower():
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print(&lt;span style="color:#e6db74">f&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#ae81ff">\r&lt;/span>&lt;span style="color:#e6db74">{&lt;/span>line&lt;span style="color:#f92672">.&lt;/span>strip()&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>, end&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 如果无法获取输出流，提供一个替代方案&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print(&lt;span style="color:#e6db74">&amp;#34;正在处理中，请等待...&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 等待进程完成&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> return_code &lt;span style="color:#f92672">=&lt;/span> process&lt;span style="color:#f92672">.&lt;/span>wait()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> return_code &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print(&lt;span style="color:#e6db74">f&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#ae81ff">\n\n&lt;/span>&lt;span style="color:#e6db74">转码完成！输出文件: &lt;/span>&lt;span style="color:#e6db74">{&lt;/span>output_file&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print(&lt;span style="color:#e6db74">f&lt;/span>&lt;span style="color:#e6db74">&amp;#34;原始文件大小: &lt;/span>&lt;span style="color:#e6db74">{&lt;/span>os&lt;span style="color:#f92672">.&lt;/span>path&lt;span style="color:#f92672">.&lt;/span>getsize(input_file) &lt;span style="color:#f92672">/&lt;/span> (&lt;span style="color:#ae81ff">1024&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#ae81ff">1024&lt;/span>)&lt;span style="color:#e6db74">:&lt;/span>&lt;span style="color:#e6db74">.2f&lt;/span>&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74"> MB&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">f&lt;/span>&lt;span style="color:#e6db74">&amp;#34;转码后文件大小: &lt;/span>&lt;span style="color:#e6db74">{&lt;/span>os&lt;span style="color:#f92672">.&lt;/span>path&lt;span style="color:#f92672">.&lt;/span>getsize(output_file) &lt;span style="color:#f92672">/&lt;/span> (&lt;span style="color:#ae81ff">1024&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#ae81ff">1024&lt;/span>)&lt;span style="color:#e6db74">:&lt;/span>&lt;span style="color:#e6db74">.2f&lt;/span>&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74"> MB&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">True&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">else&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print(&lt;span style="color:#e6db74">f&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>&lt;span style="color:#ae81ff">\n&lt;/span>&lt;span style="color:#e6db74">转码失败，ffmpeg返回错误代码: &lt;/span>&lt;span style="color:#e6db74">{&lt;/span>return_code&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">False&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">except&lt;/span> &lt;span style="color:#a6e22e">FileNotFoundError&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print(&lt;span style="color:#e6db74">&amp;#34;错误: 找不到ffmpeg。请确保ffmpeg已安装并添加到系统PATH中。&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">False&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">except&lt;/span> &lt;span style="color:#a6e22e">Exception&lt;/span> &lt;span style="color:#66d9ef">as&lt;/span> e:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print(&lt;span style="color:#e6db74">f&lt;/span>&lt;span style="color:#e6db74">&amp;#34;发生错误: &lt;/span>&lt;span style="color:#e6db74">{&lt;/span>str(e)&lt;span style="color:#e6db74">}&lt;/span>&lt;span style="color:#e6db74">&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#66d9ef">False&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">if&lt;/span> __name__ &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#e6db74">&amp;#34;__main__&amp;#34;&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> parser &lt;span style="color:#f92672">=&lt;/span> argparse&lt;span style="color:#f92672">.&lt;/span>ArgumentParser(description&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;将视频转码为H.265格式&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> parser&lt;span style="color:#f92672">.&lt;/span>add_argument(&lt;span style="color:#e6db74">&amp;#34;input_file&amp;#34;&lt;/span>, help&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;输入视频文件路径&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> parser&lt;span style="color:#f92672">.&lt;/span>add_argument(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;--intel&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> action&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;store_true&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> help&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;使用 Intel QuickSync硬件加速&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> parser&lt;span style="color:#f92672">.&lt;/span>add_argument(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;--amd&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> action&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;store_true&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> help&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;使用 AMD GPU 硬件加速&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> parser&lt;span style="color:#f92672">.&lt;/span>add_argument(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;--nvidia&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> action&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;store_true&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> help&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;使用 NVIDIA NVENC 硬件加速&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e"># 新增质量/码率可调参数&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> parser&lt;span style="color:#f92672">.&lt;/span>add_argument(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;--crf&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> type&lt;span style="color:#f92672">=&lt;/span>int,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> default&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#ae81ff">23&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> help&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;质量参数（CRF或等效值，数值越大文件越小）&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> parser&lt;span style="color:#f92672">.&lt;/span>add_argument(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;--preset&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> default&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;medium&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> choices&lt;span style="color:#f92672">=&lt;/span>[
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;ultrafast&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;fast&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;medium&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;slow&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;slower&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;veryslow&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ],
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> help&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;编码preset&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> parser&lt;span style="color:#f92672">.&lt;/span>add_argument(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#e6db74">&amp;#34;--bitrate&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> help&lt;span style="color:#f92672">=&lt;/span>&lt;span style="color:#e6db74">&amp;#34;目标码率，如2000k，优先于CRF/质量参数&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> args &lt;span style="color:#f92672">=&lt;/span> parser&lt;span style="color:#f92672">.&lt;/span>parse_args()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> sum(bool(x) &lt;span style="color:#66d9ef">for&lt;/span> x &lt;span style="color:#f92672">in&lt;/span> (args&lt;span style="color:#f92672">.&lt;/span>intel, args&lt;span style="color:#f92672">.&lt;/span>amd, args&lt;span style="color:#f92672">.&lt;/span>nvidia)) &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print(&lt;span style="color:#e6db74">&amp;#34;错误: 只能指定一个硬件加速选项&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sys&lt;span style="color:#f92672">.&lt;/span>exit(&lt;span style="color:#ae81ff">1&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> convert_to_h265(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> args&lt;span style="color:#f92672">.&lt;/span>input_file,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> use_intel&lt;span style="color:#f92672">=&lt;/span>args&lt;span style="color:#f92672">.&lt;/span>intel,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> use_amd&lt;span style="color:#f92672">=&lt;/span>args&lt;span style="color:#f92672">.&lt;/span>amd,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> use_nvidia&lt;span style="color:#f92672">=&lt;/span>args&lt;span style="color:#f92672">.&lt;/span>nvidia,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> crf&lt;span style="color:#f92672">=&lt;/span>args&lt;span style="color:#f92672">.&lt;/span>crf,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> preset&lt;span style="color:#f92672">=&lt;/span>args&lt;span style="color:#f92672">.&lt;/span>preset,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> bitrate&lt;span style="color:#f92672">=&lt;/span>args&lt;span style="color:#f92672">.&lt;/span>bitrate,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item></channel></rss>